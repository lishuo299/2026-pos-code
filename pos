import tkinter as tk
from tkinter import ttk, messagebox, scrolledtext
from datetime import datetime
import uuid


# 商品类：封装商品属性
class Product:
    def __init__(self, product_id, name, price, stock=0):
        self.product_id = product_id  # 商品编号
        self.name = name  # 商品名称
        self.price = price  # 商品单价
        self.stock = stock  # 初始库存

    def __str__(self):
        return f"{self.product_id} - {self.name} (¥{self.price:.2f})"


# 库存类：管理所有商品的库存
class Inventory:
    def __init__(self):
        self.products = {}  # 存储商品：{product_id: Product对象}

    # 添加商品到库存
    def add_product(self, product):
        if product.product_id in self.products:
            self.products[product.product_id].stock += product.stock
        else:
            self.products[product.product_id] = product

    # 查询商品
    def get_product(self, product_id):
        return self.products.get(product_id, None)

    # 更新库存（正数增加，负数减少）
    def update_stock(self, product_id, quantity):
        product = self.get_product(product_id)
        if not product:
            return False, "商品不存在"
        if product.stock + quantity < 0:
            return False, "库存不足"
        product.stock += quantity
        return True, "库存更新成功"

    # 获取库存信息
    def get_inventory_info(self):
        info = []
        for product in self.products.values():
            info.append(f"{product} - 库存：{product.stock}")
        return "\n".join(info)


# 交易类：记录单次销售/退货的明细
class Transaction:
    def __init__(self, transaction_type):
        self.transaction_id = str(uuid.uuid4())[:8]  # 简化的交易编号
        self.transaction_type = transaction_type  # "销售"或"退货"
        self.items = []  # 交易商品明细 [(商品, 数量, 单价), ...]
        self.total_amount = 0.0  # 交易总金额
        self.payment_amount = 0.0  # 支付金额（仅销售）
        self.change = 0.0  # 找零金额（仅销售）
        self.status = "未完成"  # 交易状态
        self.create_time = datetime.now().strftime("%Y-%m-%d %H:%M:%S")

    # 添加商品到交易
    def add_item(self, product, quantity):
        if quantity <= 0 and self.transaction_type == "销售":
            return False, "销售数量必须大于0"
        if quantity >= 0 and self.transaction_type == "退货":
            return False, "退货数量必须小于0"

        item_amount = product.price * abs(quantity)
        self.items.append((product, quantity, product.price))
        self.total_amount += item_amount
        return True, "商品添加成功"

    # 处理支付（仅销售）
    def process_payment(self, payment_amount):
        if self.transaction_type != "销售":
            return False, "仅销售交易需要支付"
        if payment_amount < self.total_amount:
            return False, "支付金额不足"
        self.payment_amount = payment_amount
        self.change = payment_amount - self.total_amount
        self.status = "已完成"
        return True, "支付成功"

    # 生成交易收据
    def generate_receipt(self):
        receipt = f"""
==================== 收据 ====================
交易编号：{self.transaction_id}
交易类型：{self.transaction_type}
交易时间：{self.create_time}
--------------------------------------------
商品明细：
"""
        for product, quantity, price in self.items:
            qty_str = f"+{quantity}" if quantity > 0 else f"{quantity}"
            receipt += f"{product.name} ({product.product_id}) | 数量：{qty_str} | 单价：¥{price:.2f} | 金额：¥{abs(quantity) * price:.2f}\n"

        receipt += f"""--------------------------------------------
总计金额：¥{self.total_amount:.2f}
"""
        if self.transaction_type == "销售":
            receipt += f"""支付金额：¥{self.payment_amount:.2f}
找零金额：¥{self.change:.2f}
"""
        receipt += f"""交易状态：{self.status}
============================================
"""
        return receipt


# POS系统核心类：整合所有业务逻辑
class PointOfSale:
    def __init__(self):
        self.inventory = Inventory()
        self.current_transaction = None  # 当前处理的交易

    # 开始新交易（销售/退货）
    def start_transaction(self, transaction_type):
        self.current_transaction = Transaction(transaction_type)
        return self.current_transaction.transaction_id

    # 添加商品到当前交易
    def add_item_to_transaction(self, product_id, quantity):
        if not self.current_transaction:
            return False, "请先开始新交易"

        product = self.inventory.get_product(product_id)
        if not product:
            return False, "商品不存在"

        # 检查库存（销售：减少库存，退货：增加库存）
        if self.current_transaction.transaction_type == "销售":
            if product.stock < quantity:
                return False, "库存不足"
        else:  # 退货
            # 退货时库存只增不减，无需检查
            pass

        # 添加商品到交易
        success, msg = self.current_transaction.add_item(product, quantity)
        if success:
            # 更新库存
            self.inventory.update_stock(product_id,
                                        -quantity if self.current_transaction.transaction_type == "销售" else abs(
                                            quantity))
        return success, msg

    # 处理支付
    def process_payment(self, payment_amount):
        if not self.current_transaction:
            return False, "无当前交易"
        success, msg = self.current_transaction.process_payment(payment_amount)
        return success, msg

    # 获取当前交易总额
    def get_current_total(self):
        if self.current_transaction:
            return self.current_transaction.total_amount
        return 0.0

    # 获取当前交易明细
    def get_current_items(self):
        if not self.current_transaction:
            return []
        items = []
        for product, quantity, price in self.current_transaction.items:
            items.append(f"{product.name} | 数量：{quantity} | 单价：¥{price:.2f} | 小计：¥{abs(quantity) * price:.2f}")
        return items

    # 打印收据
    def print_receipt(self):
        if self.current_transaction:
            return self.current_transaction.generate_receipt()
        return "无交易记录"


# POS系统图形界面
class POS_GUI:
    def __init__(self, root):
        self.root = root
        self.root.title("销售终端(POS)系统")
        self.root.geometry("800x600")

        # 初始化POS核心逻辑
        self.pos_system = PointOfSale()
        # 初始化测试数据
        self.init_test_data()

        # 创建界面组件
        self.create_widgets()

    # 初始化测试商品数据
    def init_test_data(self):
        test_products = [
            Product("001", "矿泉水", 2.0, 100),
            Product("002", "方便面", 5.0, 50),
            Product("003", "薯片", 8.0, 30),
            Product("004", "可乐", 3.0, 80),
            Product("005", "纸巾", 10.0, 20)
        ]
        for product in test_products:
            self.pos_system.inventory.add_product(product)

    # 创建界面组件
    def create_widgets(self):
        # 1. 交易类型选择区
        frame_type = ttk.LabelFrame(self.root, text="交易类型")
        frame_type.pack(fill="x", padx=10, pady=5)

        self.transaction_type = tk.StringVar(value="销售")
        ttk.Radiobutton(frame_type, text="销售", variable=self.transaction_type, value="销售",
                        command=self.on_transaction_type_change).pack(side="left", padx=10, pady=5)
        ttk.Radiobutton(frame_type, text="退货", variable=self.transaction_type, value="退货",
                        command=self.on_transaction_type_change).pack(side="left", padx=10, pady=5)
        ttk.Button(frame_type, text="开始新交易", command=self.start_new_transaction).pack(side="right", padx=10,
                                                                                           pady=5)

        # 2. 商品录入区
        frame_input = ttk.LabelFrame(self.root, text="商品录入")
        frame_input.pack(fill="x", padx=10, pady=5)

        ttk.Label(frame_input, text="商品编号：").grid(row=0, column=0, padx=5, pady=5)
        self.product_id_entry = ttk.Entry(frame_input, width=10)
        self.product_id_entry.grid(row=0, column=1, padx=5, pady=5)

        ttk.Label(frame_input, text="数量：").grid(row=0, column=2, padx=5, pady=5)
        self.quantity_entry = ttk.Entry(frame_input, width=10)
        self.quantity_entry.grid(row=0, column=3, padx=5, pady=5)

        ttk.Button(frame_input, text="添加商品", command=self.add_item).grid(row=0, column=4, padx=5, pady=5)
        ttk.Button(frame_input, text="查看库存", command=self.show_inventory).grid(row=0, column=5, padx=5, pady=5)

        # 3. 交易明细区
        frame_detail = ttk.LabelFrame(self.root, text="交易明细")
        frame_detail.pack(fill="both", expand=True, padx=10, pady=5)

        self.detail_text = scrolledtext.ScrolledText(frame_detail, width=80, height=15)
        self.detail_text.pack(fill="both", expand=True, padx=5, pady=5)

        # 4. 金额与支付区
        frame_payment = ttk.LabelFrame(self.root, text="金额与支付")
        frame_payment.pack(fill="x", padx=10, pady=5)

        ttk.Label(frame_payment, text="当前总额：").grid(row=0, column=0, padx=5, pady=5)
        self.total_label = ttk.Label(frame_payment, text="¥0.00", foreground="red", font=("Arial", 12, "bold"))
        self.total_label.grid(row=0, column=1, padx=5, pady=5)

        ttk.Label(frame_payment, text="支付金额：").grid(row=0, column=2, padx=5, pady=5)
        self.payment_entry = ttk.Entry(frame_payment, width=10)
        self.payment_entry.grid(row=0, column=3, padx=5, pady=5)

        ttk.Button(frame_payment, text="确认支付", command=self.process_payment).grid(row=0, column=4, padx=5, pady=5)
        ttk.Button(frame_payment, text="打印收据", command=self.print_receipt).grid(row=0, column=5, padx=5, pady=5)

    # 切换交易类型
    def on_transaction_type_change(self):
        self.detail_text.delete(1.0, tk.END)
        self.total_label.config(text="¥0.00")
        self.pos_system.current_transaction = None

    # 开始新交易
    def start_new_transaction(self):
        trans_type = self.transaction_type.get()
        trans_id = self.pos_system.start_transaction(trans_type)
        self.detail_text.delete(1.0, tk.END)
        self.detail_text.insert(tk.END,
                                f"===== 新{trans_type}交易 [{trans_id}] =====\n交易时间：{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n\n")
        self.total_label.config(text="¥0.00")
        messagebox.showinfo("提示", f"已开始新{trans_type}交易，交易编号：{trans_id}")

    # 添加商品到交易
    def add_item(self):
        try:
            product_id = self.product_id_entry.get().strip()
            quantity = int(self.quantity_entry.get().strip())

            # 退货时自动将数量转为负数
            if self.transaction_type.get() == "退货":
                quantity = -abs(quantity)

            success, msg = self.pos_system.add_item_to_transaction(product_id, quantity)
            if success:
                # 更新交易明细
                self.update_transaction_detail()
                # 更新总额
                total = self.pos_system.get_current_total()
                self.total_label.config(text=f"¥{total:.2f}")
                messagebox.showinfo("成功", msg)
            else:
                messagebox.showerror("错误", msg)
        except ValueError:
            messagebox.showerror("错误", "数量必须是整数")
        except Exception as e:
            messagebox.showerror("错误", f"添加商品失败：{str(e)}")

    # 更新交易明细显示
    def update_transaction_detail(self):
        self.detail_text.delete(1.0, tk.END)
        trans_type = self.transaction_type.get()
        trans_id = self.pos_system.current_transaction.transaction_id
        self.detail_text.insert(tk.END,
                                f"===== {trans_type}交易 [{trans_id}] =====\n交易时间：{self.pos_system.current_transaction.create_time}\n\n")

        items = self.pos_system.get_current_items()
        if items:
            for item in items:
                self.detail_text.insert(tk.END, item + "\n")
        else:
            self.detail_text.insert(tk.END, "暂无商品\n")

        total = self.pos_system.get_current_total()
        self.detail_text.insert(tk.END, f"\n累计总额：¥{total:.2f}")

    # 处理支付
    def process_payment(self):
        if self.transaction_type.get() != "销售":
            messagebox.showwarning("提示", "仅销售交易需要支付")
            return

        try:
            payment_amount = float(self.payment_entry.get().strip())
            success, msg = self.pos_system.process_payment(payment_amount)
            if success:
                messagebox.showinfo("成功", f"{msg}，找零：¥{self.pos_system.current_transaction.change:.2f}")
                self.update_transaction_detail()
            else:
                messagebox.showerror("错误", msg)
        except ValueError:
            messagebox.showerror("错误", "支付金额必须是数字")

    # 打印收据
    def print_receipt(self):
        if not self.pos_system.current_transaction:
            messagebox.showwarning("提示", "无当前交易")
            return

        receipt = self.pos_system.print_receipt()
        # 新建窗口显示收据
        receipt_window = tk.Toplevel(self.root)
        receipt_window.title("收据打印预览")
        receipt_window.geometry("500x400")

        receipt_text = scrolledtext.ScrolledText(receipt_window, width=60, height=20, font=("Courier New", 10))
        receipt_text.pack(fill="both", expand=True, padx=10, pady=10)
        receipt_text.insert(tk.END, receipt)
        receipt_text.config(state="disabled")  # 设为只读

        # 模拟打印按钮（实际开发可对接打印机API）
        ttk.Button(receipt_window, text="确认打印", command=receipt_window.destroy).pack(pady=5)

    # 查看库存
    def show_inventory(self):
        inventory_info = self.pos_system.inventory.get_inventory_info()
        # 新建窗口显示库存
        inventory_window = tk.Toplevel(self.root)
        inventory_window.title("库存信息")
        inventory_window.geometry("600x400")

        inventory_text = scrolledtext.ScrolledText(inventory_window, width=70, height=20)
        inventory_text.pack(fill="both", expand=True, padx=10, pady=10)
        inventory_text.insert(tk.END, inventory_info)
        inventory_text.config(state="disabled")


# 主程序入口
if __name__ == "__main__":
    root = tk.Tk()
    app = POS_GUI(root)
    root.mainloop()
